<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Draper IT Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f14;
    --surface: #13161d;
    --surface2: #1a1e28;
    --border: #252a38;
    --text: #e8eaf0;
    --muted: #5a6080;
    --accent: #4f8ef7;
    --new-starter: #22c55e;     --new-starter-bg: rgba(34,197,94,0.38);
    --leaver: #ef4444;          --leaver-bg: rgba(239,68,68,0.38);
    --holiday: #38bdf8;         --holiday-bg: rgba(56,189,248,0.38);
    --task: #f97316;            --task-bg: rgba(249,115,22,0.38);

    --bank-holiday: #fbbf24;    --bank-holiday-bg: rgba(251,191,36,0.42);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    padding: 20px 24px;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 18px;
    gap: 16px;
  }

  .brand-wrap { display: flex; align-items: center; gap: 14px; }

  /* ‚îÄ‚îÄ Cyber Cat Icon ‚îÄ‚îÄ */
  .cyber-cat {
    position: relative;
    width: 52px; height: 52px;
    flex-shrink: 0;
  }
  .cyber-cat::before {
    content: '';
    position: absolute;
    inset: -6px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(79,142,247,0.55) 0%, rgba(79,142,247,0.18) 50%, transparent 75%);
    animation: catGlow 3s ease-in-out infinite;
    filter: blur(4px);
  }
  @keyframes catGlow {
    0%,100% { opacity: 0.8; transform: scale(1); }
    50%      { opacity: 1;   transform: scale(1.08); }
  }
  .cyber-cat svg {
    width: 52px; height: 52px;
    position: relative; z-index: 1;
    filter: drop-shadow(0 0 8px rgba(79,142,247,0.9)) drop-shadow(0 0 20px rgba(79,142,247,0.5));
    animation: catPulse 3s ease-in-out infinite;
  }
  @keyframes catPulse {
    0%,100% { filter: drop-shadow(0 0 6px rgba(79,142,247,0.9)) drop-shadow(0 0 18px rgba(79,142,247,0.5)); }
    50%      { filter: drop-shadow(0 0 12px rgba(100,180,255,1))  drop-shadow(0 0 30px rgba(79,142,247,0.8)); }
  }

  .brand-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; white-space: nowrap; line-height: 1.15; }
  .brand-title .accent { color: var(--accent); }
  .brand-title .dim { color: var(--muted); font-weight: 400; }
  .brand-subtitle { font-size: 11px; color: var(--muted); font-family: 'DM Mono', monospace; letter-spacing: 1px; text-transform: uppercase; margin-top: 1px; }

  .header-center {
    display: flex; align-items: center; gap: 14px; flex: 1; justify-content: center;
  }

  .month-label {
    font-size: 32px; font-weight: 800; letter-spacing: -1px;
    min-width: 240px; text-align: center;
  }

  .nav-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); width: 34px; height: 34px;
    border-radius: 8px; cursor: pointer; font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s; flex-shrink: 0;
  }
  .nav-btn:hover { background: var(--border); }

  .today-btn {
    background: var(--accent); border: none; color: #fff;
    padding: 0 14px; height: 34px; border-radius: 8px; cursor: pointer;
    font-family: 'Syne', sans-serif; font-weight: 600; font-size: 13px;
    transition: opacity 0.15s; white-space: nowrap;
  }
  .today-btn:hover { opacity: .85; }

  .live-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: #22c55e; display: inline-block; margin-right: 6px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

  .header-right { display: flex; align-items: center; gap: 10px; }

  /* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
  .legend {
    display: flex; gap: 14px; flex-wrap: wrap;
    margin-bottom: 14px; align-items: center;
  }
  .legend-item {
    display: flex; align-items: center; gap: 6px;
    font-size: 11px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .8px;
  }
  .legend-dot { width: 9px; height: 9px; border-radius: 2px; }

  /* ‚îÄ‚îÄ Day name row ‚îÄ‚îÄ */
  .day-names {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-bottom: 6px;
  }
  .day-name-cell {
    text-align: center;
    font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1.5px;
    color: var(--muted); padding: 6px 0;
  }

  /* ‚îÄ‚îÄ Month grid ‚îÄ‚îÄ */
  .month-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
  }

  /* ‚îÄ‚îÄ Day cell ‚îÄ‚îÄ */
  .day-cell {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    min-height: 180px;
    display: flex; flex-direction: column;
    overflow: hidden;
    transition: border-color 0.15s;
    cursor: pointer;
    position: relative;
  }
  .day-cell:hover { border-color: var(--muted); }

  .day-cell.is-today { border-color: var(--accent); }
  .day-cell.is-today .day-num { color: var(--accent); }
  .day-cell.is-bank-holiday { background: rgba(251,191,36,0.07); border-color: rgba(251,191,36,0.5); }
  .day-cell.is-bank-holiday .day-num { color: var(--bank-holiday); }

  .day-cell-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 10px 5px;
  }
  .day-num {
    font-size: 17px; font-weight: 800; color: var(--text); line-height: 1;
  }
  .day-add {
    background: none; border: none; color: var(--muted);
    font-size: 16px; cursor: pointer; line-height: 1;
    opacity: 0; transition: opacity 0.15s;
    padding: 0 2px;
  }
  .day-cell:hover .day-add { opacity: 1; }
  .day-add:hover { color: var(--accent); }

  .day-events-wrap {
    flex: 1; padding: 0 6px 8px; display: flex; flex-direction: column; gap: 5px;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Event pills ‚îÄ‚îÄ */
  .pill {
    border-radius: 8px;
    padding: 8px 14px 8px 11px;
    border-left: 5px solid transparent;
    display: flex; align-items: center; gap: 6px;
    position: relative;
    cursor: default;
    font-size: 13px; font-weight: 700;
    color: #fff;
    line-height: 1.3;
    transition: filter 0.12s;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  .pill:hover { filter: brightness(1.12); }

  .pill.new-starter { background: var(--new-starter-bg); border-color: var(--new-starter); }
  .pill.leaver      { background: var(--leaver-bg);      border-color: var(--leaver); }
  .pill.holiday     { background: var(--holiday-bg);     border-color: var(--holiday); }
  .pill.task        { background: var(--task-bg);        border-color: var(--task); }
  .pill.bank-holiday { background: var(--bank-holiday-bg); border-color: var(--bank-holiday); color: #1a1200; font-weight: 800; text-shadow: none; }

  .pill.continuation {
    opacity: 0.7;
    border-left-color: transparent;
    border-left-width: 2px;
    padding-left: 12px;
  }
  .pill.continuation::before {
    content: '‚Ü≥';
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    margin-right: 2px;
  }

  .pill-name {
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    flex: 1;
  }

  .pill-del {
    background: none; border: none; color: rgba(255,255,255,0.5);
    font-size: 13px; cursor: pointer; line-height: 1;
    opacity: 0; transition: opacity 0.12s; flex-shrink: 0;
    padding: 0 1px;
  }
  .pill.bank-holiday .pill-del { color: rgba(0,0,0,0.4); }
  .pill:hover .pill-del { opacity: 1; }
  .pill-del:hover { color: #fff; }
  .pill.bank-holiday .pill-del:hover { color: rgba(0,0,0,0.8); }

  .overflow-pill {
    font-size: 12px; color: var(--muted);
    font-family: 'DM Mono', monospace;
    padding: 4px 8px;
  }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.72);
    backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
    z-index: 100; opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 18px; padding: 28px;
    width: 460px; max-width: 95vw;
    transform: translateY(14px); transition: transform 0.2s;
    max-height: 90vh; overflow-y: auto;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal::-webkit-scrollbar { width: 4px; }
  .modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .modal-title { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
  .modal-subtitle { font-size: 12px; color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 20px; }

  .form-group { margin-bottom: 15px; }

  label {
    display: block; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
    color: var(--muted); margin-bottom: 6px;
  }

  input, select, textarea {
    width: 100%;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 14px;
    padding: 10px 13px; outline: none;
    transition: border-color 0.15s;
    -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 65px; }
  select option { background: #1a1e28; }
  input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.6); cursor: pointer; }

  .date-mode-toggle { display: flex; gap: 8px; margin-bottom: 12px; }
  .toggle-btn {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 8px; border-radius: 9px; cursor: pointer;
    font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 600;
    text-transform: uppercase; letter-spacing: .7px;
    transition: all 0.15s; text-align: center;
  }
  .toggle-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .date-range-row {
    display: grid; grid-template-columns: 1fr auto 1fr;
    gap: 10px; align-items: end;
  }
  .date-range-arrow { color: var(--muted); font-size: 20px; text-align: center; padding-bottom: 10px; }
  .date-range-group label { margin-bottom: 5px; }

  .type-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px; }
  .type-option {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 9px; padding: 10px 6px; text-align: center;
    cursor: pointer; font-size: 10px; font-weight: 700;
    text-transform: uppercase; letter-spacing: .6px;
    transition: all 0.15s; color: var(--muted); user-select: none;
  }
  .type-option:hover { border-color: var(--muted); color: var(--text); }
  .type-option.selected-new-starter { background: var(--new-starter-bg); border-color: var(--new-starter); color: var(--new-starter); }
  .type-option.selected-leaver      { background: var(--leaver-bg);      border-color: var(--leaver);      color: var(--leaver); }
  .type-option.selected-holiday     { background: var(--holiday-bg);     border-color: var(--holiday);     color: var(--holiday); }
  .type-option.selected-task        { background: var(--task-bg);        border-color: var(--task);        color: var(--task); }
  .type-option.selected-bank-holiday { background: var(--bank-holiday-bg); border-color: var(--bank-holiday); color: var(--bank-holiday); }

  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
  .btn-cancel {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 12px; border-radius: 10px; cursor: pointer;
    font-family: 'Syne', sans-serif; font-weight: 600; font-size: 14px;
    transition: color 0.15s;
  }
  .btn-cancel:hover { color: var(--text); }
  .btn-save {
    flex: 2; background: var(--accent); border: none; color: #fff;
    padding: 12px; border-radius: 10px; cursor: pointer;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px;
    transition: opacity 0.15s;
  }
  .btn-save:hover { opacity: .85; }

  /* Scrollbar */
  .day-events-wrap::-webkit-scrollbar { display: none; }
</style>
</head>
<body>

<header>
  <div class="brand-wrap">
    <!-- Cyber Cat Icon -->
    <div class="cyber-cat">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none">
        <!-- Ears -->
        <polygon points="18,42 10,12 36,30" fill="#1a2a4a" stroke="#4f8ef7" stroke-width="2.5" stroke-linejoin="round"/>
        <polygon points="82,42 90,12 64,30" fill="#1a2a4a" stroke="#4f8ef7" stroke-width="2.5" stroke-linejoin="round"/>
        <!-- Inner ear glow -->
        <polygon points="22,38 16,20 34,32" fill="rgba(79,142,247,0.25)"/>
        <polygon points="78,38 84,20 66,32" fill="rgba(79,142,247,0.25)"/>
        <!-- Head -->
        <ellipse cx="50" cy="57" rx="34" ry="30" fill="#0d1826" stroke="#4f8ef7" stroke-width="2.5"/>
        <!-- Circuit lines on head -->
        <line x1="50" y1="30" x2="50" y2="40" stroke="#4f8ef7" stroke-width="1" opacity="0.5"/>
        <line x1="28" y1="48" x2="38" y2="48" stroke="#4f8ef7" stroke-width="1" opacity="0.4"/>
        <line x1="62" y1="48" x2="72" y2="48" stroke="#4f8ef7" stroke-width="1" opacity="0.4"/>
        <!-- Eyes -->
        <ellipse cx="37" cy="53" rx="8" ry="7" fill="#0a1520" stroke="#4f8ef7" stroke-width="1.5"/>
        <ellipse cx="63" cy="53" rx="8" ry="7" fill="#0a1520" stroke="#4f8ef7" stroke-width="1.5"/>
        <!-- Pupils - vertical slit -->
        <ellipse cx="37" cy="53" rx="3" ry="6" fill="#4f8ef7" opacity="0.9"/>
        <ellipse cx="63" cy="53" rx="3" ry="6" fill="#4f8ef7" opacity="0.9"/>
        <!-- Eye glow dots -->
        <circle cx="35" cy="51" r="1.2" fill="white" opacity="0.8"/>
        <circle cx="61" cy="51" r="1.2" fill="white" opacity="0.8"/>
        <!-- Nose -->
        <polygon points="50,63 47,67 53,67" fill="#4f8ef7" opacity="0.8"/>
        <!-- Mouth -->
        <path d="M44,70 Q47,74 50,70 Q53,74 56,70" stroke="#4f8ef7" stroke-width="1.5" opacity="0.7" fill="none" stroke-linecap="round"/>
        <!-- Whiskers left -->
        <line x1="16" y1="62" x2="40" y2="64" stroke="#4f8ef7" stroke-width="1.2" opacity="0.5"/>
        <line x1="16" y1="68" x2="40" y2="67" stroke="#4f8ef7" stroke-width="1.2" opacity="0.5"/>
        <!-- Whiskers right -->
        <line x1="84" y1="62" x2="60" y2="64" stroke="#4f8ef7" stroke-width="1.2" opacity="0.5"/>
        <line x1="84" y1="68" x2="60" y2="67" stroke="#4f8ef7" stroke-width="1.2" opacity="0.5"/>
        <!-- Collar/tech band -->
        <rect x="24" y="82" width="52" height="8" rx="4" fill="#0d1826" stroke="#4f8ef7" stroke-width="1.5"/>
        <circle cx="50" cy="86" r="3" fill="#4f8ef7" opacity="0.9"/>
        <line x1="35" y1="86" x2="44" y2="86" stroke="#4f8ef7" stroke-width="1" opacity="0.5"/>
        <line x1="56" y1="86" x2="65" y2="86" stroke="#4f8ef7" stroke-width="1" opacity="0.5"/>
      </svg>
    </div>
    <div>
      <div class="brand-title">Draper IT <span class="dim">Calendar</span></div>
      <div class="brand-subtitle">Support Team Wallboard</div>
    </div>
  </div>

  <div class="header-center">
    <button class="nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
    <div class="month-label" id="monthLabel"></div>
    <button class="nav-btn" onclick="changeMonth(1)">‚Ä∫</button>
  </div>

  <div class="header-right">
    <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">
      <span class="live-dot"></span><span id="todayLabel"></span>
    </span>
    <div id="statusMsg" style="display:none;font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);background:rgba(79,142,247,0.12);padding:6px 12px;border-radius:6px;border:1px solid rgba(79,142,247,0.3);line-height:1.5;"></div>
    <button class="today-btn" onclick="goToday()">This Month</button>
  </div>
</header>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:var(--new-starter)"></div>New Starter</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--leaver)"></div>Leaver</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--holiday)"></div>Holiday</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--task)"></div>Task</div>
  <div class="legend-item"><div class="legend-dot" style="background:var(--bank-holiday)"></div>Bank Holiday</div>
  <div style="margin-left:auto;font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;">Click day or + to add ¬∑ hover pill ‚Üí ‚úï to remove</div>
</div>

<div class="day-names" id="dayNames"></div>
<div class="month-grid" id="monthGrid"></div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title">Add Calendar Item</div>
    <div class="modal-subtitle" id="modalDate">‚Äî</div>

    <div class="form-group">
      <label>Type</label>
      <div class="type-grid">
        <div class="type-option" onclick="selectType('new-starter')" id="type-new-starter">üü¢ New Starter</div>
        <div class="type-option" onclick="selectType('leaver')"      id="type-leaver">üî¥ Leaver</div>
        <div class="type-option" onclick="selectType('holiday')"     id="type-holiday">üü° Holiday</div>
        <div class="type-option" onclick="selectType('task')"        id="type-task">üü£ Task</div>
        <div class="type-option" onclick="selectType('bank-holiday')" id="type-bank-holiday">üè¶ Bank Holiday</div>
      </div>
    </div>

    <div class="form-group">
      <label>Date</label>
      <div class="date-mode-toggle">
        <div class="toggle-btn active" id="modeSingle" onclick="setDateMode('single')">Single Day</div>
        <div class="toggle-btn"        id="modeRange"  onclick="setDateMode('range')">Date Range</div>
      </div>
      <div id="singleDateWrap">
        <input type="date" id="eventDateSingle">
      </div>
      <div id="rangeDateWrap" style="display:none">
        <div class="date-range-row">
          <div class="date-range-group">
            <label>From</label>
            <input type="date" id="eventDateFrom">
          </div>
          <div class="date-range-arrow">‚Üí</div>
          <div class="date-range-group">
            <label>To</label>
            <input type="date" id="eventDateTo">
          </div>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label>Name / Title</label>
      <input type="text" id="eventName" placeholder="e.g. Sarah Johnson">
    </div>

    <div class="form-group">
      <label>Note (optional)</label>
      <textarea id="eventNote" placeholder="e.g. Annual leave approved"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save"   onclick="saveEvent()">Add to Calendar</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@azure/msal-browser@2.38.3/lib/msal-browser.min.js"></script>
<script>
  // ‚îÄ‚îÄ SharePoint / MSAL Config ‚îÄ‚îÄ
  const TENANT_ID   = '8468f04e-ed1d-433f-99d9-2641bb0f49f6';
  const CLIENT_ID   = '72e81aaf-8551-41b3-b12f-966e31b08383';
  const SITE_URL    = 'https://drapertoolsltd.sharepoint.com/sites/techsupport';
  const LIST_NAME   = 'DraperITCalendar';
  const GRAPH_BASE  = 'https://graph.microsoft.com/v1.0';
  const SCOPES = [
    'https://graph.microsoft.com/Sites.ReadWrite.All',
    'https://graph.microsoft.com/Lists.ReadWrite.All'
  ];

  const msalConfig = {
    auth: {
      clientId: CLIENT_ID,
      authority: `https://login.microsoftonline.com/${TENANT_ID}`,
      redirectUri: 'https://draperit.github.io/draper-it-calendar/'
    },
    cache: { cacheLocation: 'sessionStorage' }
  };

  const msalInstance = new msal.PublicClientApplication(msalConfig);
  let graphSiteId  = null;
  let graphListId  = null;
  let currentAccount = null;

  async function getToken() {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      await msalInstance.loginPopup({ scopes: SCOPES });
    }
    currentAccount = msalInstance.getAllAccounts()[0];
    const result = await msalInstance.acquireTokenSilent({
      scopes: SCOPES, account: currentAccount
    }).catch(() => msalInstance.acquireTokenPopup({ scopes: SCOPES }));
    return result.accessToken;
  }

  async function graphGet(url) {
    const token = await getToken();
    const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    if (!res.ok) throw new Error(`Graph GET failed: ${res.status} ${await res.text()}`);
    return res.json();
  }

  async function graphPost(url, body) {
    const token = await getToken();
    const res = await fetch(url, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`Graph POST failed: ${res.status} ${await res.text()}`);
    return res.json();
  }

  async function graphDelete(url) {
    const token = await getToken();
    const res = await fetch(url, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(`Graph DELETE failed: ${res.status} ${await res.text()}`);
  }

  async function getSiteAndListId() {
    if (graphSiteId && graphListId) return;
    setStatus('Connecting to SharePoint‚Ä¶');

    // Try multiple ways to resolve the site
    const attempts = [
      `${GRAPH_BASE}/sites/drapertoolsltd.sharepoint.com:/sites/techsupport`,
      `${GRAPH_BASE}/sites/drapertoolsltd.sharepoint.com,sites,techsupport`,
      `${GRAPH_BASE}/sites?search=techsupport`,
    ];

    let siteData = null;
    let lastErr  = null;

    for (const url of attempts) {
      try {
        const res = await graphGet(url);
        // search returns a value array, direct lookup returns object with id
        if (res.id) { siteData = res; break; }
        if (res.value && res.value.length > 0) { siteData = res.value[0]; break; }
      } catch(e) { lastErr = e; }
    }

    if (!siteData || !siteData.id) {
      // Last resort ‚Äî list all sites the user can access
      let siteList = '(could not retrieve)';
      try {
        const all = await graphGet(`${GRAPH_BASE}/sites?search=*`);
        siteList = (all.value || []).map(s => `‚Ä¢ ${s.displayName} ‚Üí ${s.webUrl}`).join('\n');
      } catch(e) { /* ignore */ }

      throw new Error(
        `Could not find SharePoint site.\n\n` +
        `Last error: ${lastErr ? lastErr.message : 'unknown'}\n\n` +
        `Sites accessible to your account:\n${siteList}\n\n` +
        `Check the Azure AD app has Sites.ReadWrite.All permission with admin consent granted.`
      );
    }

    graphSiteId = siteData.id;

    // Step 2 ‚Äî find the list
    let allLists;
    try {
      allLists = await graphGet(`${GRAPH_BASE}/sites/${graphSiteId}/lists?$select=id,displayName,name`);
    } catch(e) {
      throw new Error(`Connected to site but could not retrieve lists.\n\nDetails: ${e.message}`);
    }

    const lists = allLists.value || [];
    let match = lists.find(l => l.displayName === LIST_NAME)
             || lists.find(l => l.displayName.toLowerCase() === LIST_NAME.toLowerCase())
             || lists.find(l => l.name === LIST_NAME)
             || lists.find(l => l.name.toLowerCase() === LIST_NAME.toLowerCase());

    if (!match) {
      const available = lists
        .filter(l => !['Documents','Style Library','Site Pages','Form Templates',
                       'Site Assets','Composed Looks','Master Page Gallery'].includes(l.displayName))
        .map(l => `‚Ä¢ "${l.displayName}" (internal: ${l.name})`)
        .join('\n');
      throw new Error(
        `Connected to site but could not find list "${LIST_NAME}".\n\n` +
        `Lists on this site:\n${available || '(none found)'}\n\n` +
        `Check the list name matches exactly.`
      );
    }

    graphListId = match.id;
    setStatus('');
  }

  async function loadEvents() {
    await getSiteAndListId();
    setStatus('Loading events‚Ä¶');
    const data = await graphGet(
      `${GRAPH_BASE}/sites/${graphSiteId}/lists/${graphListId}/items?expand=fields&$top=999`
    );
    allEvents = data.value.map(item => ({
      id:        item.id,
      type:      item.fields.EventType      || '',
      name:      item.fields.EventName      || '',
      note:      item.fields.Note           || '',
      startDate: item.fields.StartDate      || '',
      endDate:   item.fields.EndDate        || ''
    }));
    setStatus('');
    render();
  }

  async function saveEventToSharePoint(ev) {
    await getSiteAndListId();
    setStatus('Saving‚Ä¶');
    const created = await graphPost(
      `${GRAPH_BASE}/sites/${graphSiteId}/lists/${graphListId}/items`,
      { fields: {
        Title:     ev.name,
        EventId:   ev.id,
        EventType: ev.type,
        EventName: ev.name,
        StartDate: ev.startDate,
        EndDate:   ev.endDate,
        Note:      ev.note
      }}
    );
    // Update local id to the SharePoint item id
    ev.id = created.id;
    setStatus('');
  }

  async function deleteEventFromSharePoint(spId) {
    await getSiteAndListId();
    setStatus('Deleting‚Ä¶');
    await graphDelete(`${GRAPH_BASE}/sites/${graphSiteId}/lists/${graphListId}/items/${spId}`);
    setStatus('');
  }

  function setStatus(msg, isError) {
    const el = document.getElementById('statusMsg');
    if (!el) return;
    if (!msg) { el.style.display = 'none'; el.textContent = ''; return; }
    el.textContent = msg;
    el.style.display = 'block';
    if (isError) {
      el.style.color = '#ef4444';
      el.style.background = 'rgba(239,68,68,0.12)';
      el.style.borderColor = 'rgba(239,68,68,0.3)';
      el.style.whiteSpace = 'pre-wrap';
      el.style.maxWidth = '600px';
    } else {
      el.style.color = 'var(--accent)';
      el.style.background = 'rgba(79,142,247,0.12)';
      el.style.borderColor = 'rgba(79,142,247,0.3)';
      el.style.whiteSpace = 'normal';
      el.style.maxWidth = '';
    }
  }

  // ‚îÄ‚îÄ Calendar state ‚îÄ‚îÄ
  const DAY_NAMES = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
  const MONTH_NAMES = ['January','February','March','April','May','June',
                       'July','August','September','October','November','December'];
  const TYPE_LABELS = {
    'new-starter':'New Starter','leaver':'Leaver',
    'holiday':'Holiday','task':'Task',
    'bank-holiday':'Bank Holiday'
  };
  const MAX_PILLS = 3;

  const UK_BANK_HOLIDAYS = {
    '2024-01-01': "New Year's Day",
    '2024-03-29': 'Good Friday',
    '2024-04-01': 'Easter Monday',
    '2024-05-06': 'Early May Bank Holiday',
    '2024-05-27': 'Spring Bank Holiday',
    '2024-08-26': 'Summer Bank Holiday',
    '2024-12-25': 'Christmas Day',
    '2024-12-26': 'Boxing Day',
    '2025-01-01': "New Year's Day",
    '2025-04-18': 'Good Friday',
    '2025-04-21': 'Easter Monday',
    '2025-05-05': 'Early May Bank Holiday',
    '2025-05-26': 'Spring Bank Holiday',
    '2025-08-25': 'Summer Bank Holiday',
    '2025-12-25': 'Christmas Day',
    '2025-12-26': 'Boxing Day',
    '2026-01-01': "New Year's Day",
    '2026-04-03': 'Good Friday',
    '2026-04-06': 'Easter Monday',
    '2026-05-04': 'Early May Bank Holiday',
    '2026-05-25': 'Spring Bank Holiday',
    '2026-08-31': 'Summer Bank Holiday',
    '2026-12-25': 'Christmas Day',
    '2026-12-28': 'Boxing Day (substitute)',
  };

  let allEvents = [];
  let monthOffset = 0;
  let selectedType = '';
  let dateMode = 'single';
  let modalStartKey = null;

  function dateKey(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function parseKey(k) {
    const [y,m,d] = k.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  function formatDisplay(k) {
    return parseKey(k).toLocaleDateString('en-GB', {day:'numeric', month:'short'});
  }

  /* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
  function render() {
    const today = new Date(); today.setHours(0,0,0,0);
    const refDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
    const year  = refDate.getFullYear();
    const month = refDate.getMonth();

    document.getElementById('monthLabel').textContent = `${MONTH_NAMES[month]} ${year}`;
    document.getElementById('todayLabel').textContent =
      today.toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'});

    const dayNamesEl = document.getElementById('dayNames');
    dayNamesEl.innerHTML = '';
    DAY_NAMES.forEach(n => {
      const cell = document.createElement('div');
      cell.className = 'day-name-cell';
      cell.textContent = n;
      dayNamesEl.appendChild(cell);
    });

    const grid = document.getElementById('monthGrid');
    grid.innerHTML = '';

    const first   = new Date(year, month, 1);
    const firstDow = first.getDay();
    const firstCol = firstDow === 0 ? 6 : firstDow - 1;
    const spacerCount = firstCol <= 4 ? firstCol : 0;

    for (let s = 0; s < spacerCount; s++) {
      const spacer = document.createElement('div');
      spacer.className = 'day-cell day-spacer';
      spacer.style.visibility = 'hidden';
      spacer.style.pointerEvents = 'none';
      grid.appendChild(spacer);
    }

    const cur = new Date(first);
    while (cur.getMonth() === month) {
      const dow = cur.getDay();
      if (dow !== 0 && dow !== 6) {
        const date = new Date(cur);
        const key  = dateKey(date);
        const isToday = key === dateKey(today);

        const cell = document.createElement('div');
        cell.className = 'day-cell' + (isToday ? ' is-today' : '');

        const cellHeader = document.createElement('div');
        cellHeader.className = 'day-cell-header';

        const numEl = document.createElement('div');
        numEl.className = 'day-num';
        numEl.textContent = date.getDate();

        const addBtn = document.createElement('button');
        addBtn.className = 'day-add';
        addBtn.textContent = '+';
        addBtn.title = 'Add item';
        addBtn.onclick = e => { e.stopPropagation(); openModal(key, date); };

        cellHeader.appendChild(numEl);
        cellHeader.appendChild(addBtn);
        cell.appendChild(cellHeader);
        cell.onclick = () => openModal(key, date);

        const eventsWrap = document.createElement('div');
        eventsWrap.className = 'day-events-wrap';

        const bhName = UK_BANK_HOLIDAYS[key];
        if (bhName) {
          cell.classList.add('is-bank-holiday');
          const bh = document.createElement('div');
          bh.className = 'pill bank-holiday';
          const bhSpan = document.createElement('span');
          bhSpan.className = 'pill-name';
          bhSpan.textContent = 'üè¶ ' + bhName;
          bh.appendChild(bhSpan);
          eventsWrap.appendChild(bh);
        }

        const dayEvs = allEvents.filter(ev => key >= ev.startDate && key <= ev.endDate);
        const bhSlots = bhName ? 1 : 0;
        const visible = dayEvs.slice(0, MAX_PILLS - bhSlots);
        const hidden  = dayEvs.length - visible.length;

        visible.forEach(ev => {
          const isStart = key === ev.startDate;
          const isMulti = ev.startDate !== ev.endDate;

          const pill = document.createElement('div');
          pill.className = `pill ${ev.type}${isMulti && !isStart ? ' continuation' : ''}`;

          const nameEl = document.createElement('span');
          nameEl.className = 'pill-name';
          nameEl.textContent = ev.name;
          if (isMulti && isStart) nameEl.textContent += ` (‚Üí${formatDisplay(ev.endDate)})`;
          pill.appendChild(nameEl);

          const delBtn = document.createElement('button');
          delBtn.className = 'pill-del';
          delBtn.textContent = '‚úï';
          delBtn.title = 'Remove';
          delBtn.onclick = e => { e.stopPropagation(); deleteEvent(ev.id); };
          pill.appendChild(delBtn);

          eventsWrap.appendChild(pill);
        });

        if (hidden > 0) {
          const more = document.createElement('div');
          more.className = 'overflow-pill';
          more.textContent = `+${hidden} more`;
          eventsWrap.appendChild(more);
        }

        cell.appendChild(eventsWrap);
        grid.appendChild(cell);
      }
      cur.setDate(cur.getDate() + 1);
    }
  }

  /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
  function openModal(key, d) {
    modalStartKey = key;
    selectedType  = '';
    document.querySelectorAll('.type-option').forEach(el => el.className = 'type-option');
    document.getElementById('eventName').value = '';
    document.getElementById('eventNote').value = '';
    document.getElementById('eventDateSingle').value = key;
    document.getElementById('eventDateFrom').value   = key;
    document.getElementById('eventDateTo').value     = key;
    setDateMode('single');
    document.getElementById('modalDate').textContent =
      d.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    document.getElementById('modalOverlay').classList.add('open');
    setTimeout(() => document.getElementById('eventName').focus(), 180);
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
  }

  function selectType(type) {
    selectedType = type;
    document.querySelectorAll('.type-option').forEach(el => el.className = 'type-option');
    document.getElementById(`type-${type}`).className = `type-option selected-${type}`;
    if (type === 'holiday' && dateMode === 'single') setDateMode('range');
  }

  function setDateMode(mode) {
    dateMode = mode;
    document.getElementById('modeSingle').classList.toggle('active', mode === 'single');
    document.getElementById('modeRange').classList.toggle('active',  mode === 'range');
    document.getElementById('singleDateWrap').style.display = mode === 'single' ? '' : 'none';
    document.getElementById('rangeDateWrap').style.display  = mode === 'range'  ? '' : 'none';
    if (mode === 'range') {
      const s = document.getElementById('eventDateSingle').value || modalStartKey || '';
      document.getElementById('eventDateFrom').value = s;
      document.getElementById('eventDateTo').value   = s;
    } else {
      document.getElementById('eventDateSingle').value =
        document.getElementById('eventDateFrom').value || modalStartKey || '';
    }
  }

  function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  async function saveEvent() {
    const name = document.getElementById('eventName').value.trim();
    if (!selectedType) { alert('Please select a type.');         return; }
    if (!name)         { alert('Please enter a name or title.'); return; }

    let startDate, endDate;
    if (dateMode === 'single') {
      startDate = document.getElementById('eventDateSingle').value;
      endDate   = startDate;
    } else {
      startDate = document.getElementById('eventDateFrom').value;
      endDate   = document.getElementById('eventDateTo').value;
    }
    if (!startDate)          { alert('Please choose a date.');               return; }
    if (endDate < startDate) { alert('End date must be on or after start.'); return; }

    const note = document.getElementById('eventNote').value.trim();
    const ev = { id: uid(), type: selectedType, name, note, startDate, endDate };

    closeModal();

    try {
      await saveEventToSharePoint(ev);
      allEvents.push(ev);
      render();
    } catch(err) {
      alert('Failed to save to SharePoint: ' + err.message);
    }
  }

  async function deleteEvent(id) {
    if (!confirm('Remove this event?')) return;
    try {
      await deleteEventFromSharePoint(id);
      allEvents = allEvents.filter(ev => ev.id !== id);
      render();
    } catch(err) {
      alert('Failed to delete: ' + err.message);
    }
  }

  function changeMonth(dir) { monthOffset += dir; render(); }
  function goToday()        { monthOffset = 0;    render(); }

  document.getElementById('modalOverlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  document.getElementById('eventDateFrom').addEventListener('change', () => {
    const f = document.getElementById('eventDateFrom').value;
    if (document.getElementById('eventDateTo').value < f)
      document.getElementById('eventDateTo').value = f;
  });

  // ‚îÄ‚îÄ Boot: handle MSAL redirect then load events ‚îÄ‚îÄ
  msalInstance.handleRedirectPromise().then(() => {
    render(); // render empty grid immediately
    loadEvents().catch(err => {
      setStatus('‚ùå ' + err.message, true);
    });
  });
</script>
</body>
</html>
